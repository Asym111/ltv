# Шаг 7: Auto Tier Upgrade (Bronze → Silver → Gold)

## Что было добавлено

### 1. Правила порогов уровней (app/core/tier_rules.py)
- Bronze: по умолчанию
- Silver: от 300,000 KZT
- Gold: от 1,000,000 KZT

### 2. Сервис пересчета уровня (app/services/tier.py)
Функция `recompute_user_tier(db, user)` автоматически:
- Рассчитывает total_spent по всем транзакциям
- Определяет новый уровень по пороговым значениям
- Обновляет user.loyalty_tier, если уровень изменился

### 3. Интеграция в создание транзакции (app/api/transactions.py)
После каждой покупки происходит:
1. ✅ Создание транзакции
2. ✅ Списание/начисление бонусов
3. ✅ **Пересчет уровня лояльности**
4. ✅ Сохранение в БД

## Как это работает

**Пример:**
- Клиент делает покупку на 200,000 KZT → остается Bronze
- Клиент делает покупку на 100,000 KZT → всего 300,000 → **автоматически переходит на Silver**
- Клиент делает покупки на 700,000 KZT → всего 1,000,000 → **автоматически переходит на Gold**

При переходе на новый уровень:
- Процент начисления бонусов увеличивается
- Bronze: 1% → Silver: 1.5% → Gold: 2%
- Клиент видит свой новый tier в карточке (/api/crm/client/{phone})

## Тестирование

Откройте http://127.0.0.1:8000/docs и:
1. Создайте пользователя
2. Создайте несколько транзакций с нарастающей суммой
3. Смотрите /api/crm/client/{phone} - там будет обновляться loyalty_tier
