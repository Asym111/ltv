{% extends "base.html" %}

{% block topbar_actions %}
<button class="btn btn-sm btn-outline-secondary" type="button" id="txRefreshBtn">
  <i class="bi bi-arrow-repeat me-1"></i> Обновить
</button>

<button class="btn btn-sm btn-success" type="button" id="txOpenCreateBtn">
  <i class="bi bi-plus-circle me-1"></i> Создать транзакцию
</button>
{% endblock %}

{% block content %}
<div class="row g-3">

  <div class="col-12">
    <div class="card p-3">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div>
          <div class="h6 mb-0">Поиск транзакций</div>
          <div class="text-muted small">Введи телефон клиента и нажми “Найти”.</div>
        </div>

        <div class="d-flex gap-2">
          <input class="form-control" id="txPhoneInput" placeholder="77001234567 или 87770000000" style="min-width: 280px;">
          <button class="btn btn-primary" id="txSearchBtn"><i class="bi bi-search me-1"></i>Найти</button>
        </div>
      </div>
      <div class="text-muted small mt-2">Подсказка: оставь поле телефона пустым и нажми “Найти” — загрузятся последние 200 транзакций.</div>
    </div>
  </div>

  <div class="col-12">
    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="h6 mb-0">Результаты</div>
          <div class="text-muted small" id="txMeta"></div>
        </div>
        <div class="text-muted small">Лимит: 200</div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Дата</th>
              <th>Телефон</th>
              <th class="text-end">Сумма</th>
              <th class="text-end">Списано</th>
              <th class="text-end">Начислено</th>
              <th>Статус</th>
              <th>Комментарий</th>
              <th class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody id="txTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Create Transaction Modal -->
<div class="modal fade" id="txCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="h6 mb-0">Создать транзакцию</div>
          <div class="text-muted small">Создание + начисление/списание выполняется здесь.</div>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Телефон</label>
            <input class="form-control" id="txUserPhone" placeholder="77001234567">
            <div class="small text-muted mt-1" id="txClientMeta"></div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Сумма</label>
            <input class="form-control" id="txAmount" type="number" min="1" step="1" value="100000">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Списать</label>
            <input class="form-control" id="txRedeem" type="number" min="0" step="1" value="0">
            <div class="small text-muted mt-1" id="txRedeemHint">Доступно: —</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Метод оплаты</label>
            <select class="form-select" id="txPaymentMethod">
              <option value="CASH" selected>Наличка</option>
              <option value="CARD">Карта</option>
              <option value="TRANSFER">Перевод</option>
              <option value="MIXED">Смешанный</option>
              <option value="OTHER">Другое</option>
            </select>
          </div>

          <div class="col-12 col-md-8">
            <label class="form-label">Комментарий</label>
            <input class="form-control" id="txComment" placeholder="Комментарий (опционально)">
          </div>

          <div class="col-12">
            <div class="text-muted small">Если клиента нет — можно указать данные для автосоздания (опционально)</div>
          </div>

          <div class="col-12 col-md-5">
            <label class="form-label">ФИО (full_name)</label>
            <input class="form-control" id="txFullName" placeholder="Asym Test">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Дата рождения (birth_date)</label>
            <input class="form-control" id="txBirthDate" placeholder="ДД.ММ.ГГГГ">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Уровень</label>
            <select class="form-select" id="txTier">
              <option value="">Авто</option>
              <option value="Bronze">Bronze</option>
              <option value="Silver">Silver</option>
              <option value="Gold">Gold</option>
            </select>
          </div>
        </div>

        <div class="alert alert-danger d-none mt-3" id="txCreateError"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
        <button class="btn btn-success" id="txCreateSubmit"><i class="bi bi-check2-circle me-1"></i>Провести</button>
      </div>
    </div>
  </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="txRefundModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="h6 mb-0">Возврат</div>
          <div class="text-muted small" id="txRefundTitle"></div>
        </div>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="txRefundFull">
          <label class="form-check-label" for="txRefundFull">Полный возврат</label>
        </div>

        <div class="mb-2">
          <label class="form-label">Сумма возврата</label>
          <input class="form-control" id="txRefundAmount" type="number" min="1" step="1" placeholder="Например: 50000">
          <div class="small text-muted mt-1" id="txRefundHint"></div>
        </div>

        <div class="mb-2">
          <label class="form-label">Комментарий</label>
          <input class="form-control" id="txRefundComment" placeholder="Причина/примечание (опционально)">
        </div>

        <div class="alert alert-danger d-none mt-2" id="txRefundError"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
        <button class="btn btn-danger" id="txRefundSubmit"><i class="bi bi-arrow-counterclockwise me-1"></i>Сделать возврат</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const txTbody = document.getElementById('txTbody');
  const txMeta = document.getElementById('txMeta');
  const txPhoneInput = document.getElementById('txPhoneInput');
  const txSearchBtn = document.getElementById('txSearchBtn');
  const txRefreshBtn = document.getElementById('txRefreshBtn');
  const txOpenCreateBtn = document.getElementById('txOpenCreateBtn');

  const txCreateModal = new bootstrap.Modal(document.getElementById('txCreateModal'));
  const txCreateError = document.getElementById('txCreateError');
  const txCreateSubmit = document.getElementById('txCreateSubmit');

  const txUserPhone = document.getElementById('txUserPhone');
  const txClientMeta = document.getElementById('txClientMeta');
  const txRedeemHint = document.getElementById('txRedeemHint');

  const txRefundModal = new bootstrap.Modal(document.getElementById('txRefundModal'));
  const txRefundTitle = document.getElementById('txRefundTitle');
  const txRefundHint = document.getElementById('txRefundHint');
  const txRefundFull = document.getElementById('txRefundFull');
  const txRefundAmount = document.getElementById('txRefundAmount');
  const txRefundComment = document.getElementById('txRefundComment');
  const txRefundError = document.getElementById('txRefundError');
  const txRefundSubmit = document.getElementById('txRefundSubmit');

  let lastPhone = '';
  let refundTx = null;
  let currentClientAvailable = null;

  async function apiGetJson(url) {
    const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function apiPostJson(url, payload) {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function fmtDate(s) {
    try { return new Date(s).toLocaleString(); } catch { return s; }
  }

  function esc(s) {
    return (s ?? '').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function statusBadge(tx) {
    const st = tx.status || 'completed';
    if (st === 'refunded') return '<span class="badge text-bg-danger">Возврат</span>';
    if (st === 'partially_refunded') return '<span class="badge text-bg-warning">Частичный возврат</span>';
    return '<span class="badge text-bg-success">Принято</span>';
  }

  function renderTxRows(rows) {
    txTbody.innerHTML = '';
    for (const t of rows) {
      const canRefund = (t.status !== 'refunded');
      const btnRefund = canRefund
        ? `<button class="btn btn-sm btn-outline-danger" data-act="refund" data-id="${t.id}"><i class="bi bi-arrow-counterclockwise me-1"></i>Возврат</button>`
        : `<button class="btn btn-sm btn-outline-danger" disabled><i class="bi bi-arrow-counterclockwise me-1"></i>Возврат</button>`;

      const btnCard = `<a class="btn btn-sm btn-outline-secondary" href="/admin/client/${encodeURIComponent(t.user_phone || '')}">Карточка</a>`;

      const refundedInfo = (t.refunded_amount && t.refunded_amount > 0)
        ? `<div class="small text-muted">Возврат: ${t.refunded_amount}</div>`
        : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t.id}</td>
        <td>${fmtDate(t.created_at)}</td>
        <td>${esc(t.user_phone || '')}</td>
        <td class="text-end">${t.amount}</td>
        <td class="text-end">${t.redeem_points}</td>
        <td class="text-end">${t.earned_points}</td>
        <td>${statusBadge(t)}${refundedInfo}</td>
        <td>${esc(t.comment || '')}</td>
        <td class="text-end d-flex gap-2 justify-content-end">
          ${btnCard}
          ${btnRefund}
        </td>
      `;
      txTbody.appendChild(tr);
    }
  }

  async function loadTransactions(phone) {
    const qs = new URLSearchParams({ limit: '200', offset: '0' });
    if (phone) qs.set('phone', phone);
    const rows = await apiGetJson(`/api/transactions/?${qs.toString()}`);
    txMeta.textContent = phone ? `Найдено: ${rows.length} (тел: ${phone})` : `Последние: ${rows.length}`;
    renderTxRows(rows);
  }

  async function loadClientMeta(phone) {
    currentClientAvailable = null;
    txClientMeta.textContent = '';
    txRedeemHint.textContent = 'Доступно: —';

    const p = (phone || '').trim();
    if (!p) return;

    try {
      const c = await apiGetJson(`/api/crm/client/${encodeURIComponent(p)}`);
      const name = c.full_name || '—';
      const tier = c.tier || '—';
      const bal = (c.bonus_balance ?? c.available ?? null);

      if (bal !== null && bal !== undefined) currentClientAvailable = Number(bal);

      txClientMeta.textContent = `Клиент: ${name} • Уровень: ${tier}`;
      txRedeemHint.textContent = `Доступно: ${currentClientAvailable ?? '—'}`;

      document.getElementById('txFullName').value = c.full_name || '';
      document.getElementById('txTier').value = c.tier || '';

      if (c.birth_date) {
        const d = new Date(c.birth_date);
        if (!isNaN(d.getTime())) {
          const dd = String(d.getDate()).padStart(2,'0');
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const yy = d.getFullYear();
          document.getElementById('txBirthDate').value = `${dd}.${mm}.${yy}`;
        }
      }
    } catch (e) {
      txClientMeta.textContent = 'Клиент не найден — будет создан при проведении.';
    }
  }

  function parseBirthDate(s) {
    const v = (s || '').trim();
    if (!v) return null;
    const m = v.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if (!m) return null;
    const dd = m[1], mm = m[2], yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }

  txSearchBtn.addEventListener('click', async () => {
    const phone = txPhoneInput.value.trim();
    lastPhone = phone;
    await loadTransactions(phone);
  });

  txRefreshBtn.addEventListener('click', async () => {
    await loadTransactions(lastPhone);
  });

  txOpenCreateBtn.addEventListener('click', async () => {
    txCreateError.classList.add('d-none');
    txCreateError.textContent = '';
    document.getElementById('txAmount').value = 100000;
    document.getElementById('txRedeem').value = 0;
    document.getElementById('txPaymentMethod').value = 'CASH';
    document.getElementById('txComment').value = '';
    txUserPhone.value = (txPhoneInput.value || '').trim();
    document.getElementById('txFullName').value = '';
    document.getElementById('txBirthDate').value = '';
    document.getElementById('txTier').value = '';

    await loadClientMeta(txUserPhone.value);
    txCreateModal.show();
  });

  txUserPhone.addEventListener('blur', async () => {
    await loadClientMeta(txUserPhone.value);
  });

  txCreateSubmit.addEventListener('click', async () => {
    txCreateSubmit.disabled = true;
    txCreateError.classList.add('d-none');

    try {
      const payload = {
        user_phone: txUserPhone.value.trim(),
        amount: Number(document.getElementById('txAmount').value || 0),
        redeem_points: Number(document.getElementById('txRedeem').value || 0),
        payment_method: document.getElementById('txPaymentMethod').value,
        comment: document.getElementById('txComment').value || '',
        full_name: document.getElementById('txFullName').value || null,
        birth_date: parseBirthDate(document.getElementById('txBirthDate').value),
        tier: document.getElementById('txTier').value || null
      };

      if (currentClientAvailable !== null && payload.redeem_points > currentClientAvailable) {
        payload.redeem_points = currentClientAvailable;
      }

      await apiPostJson('/api/transactions/', payload);
      txCreateModal.hide();
      await loadTransactions(lastPhone);
    } catch (e) {
      txCreateError.textContent = (e && e.message) ? e.message : String(e);
      txCreateError.classList.remove('d-none');
    } finally {
      txCreateSubmit.disabled = false;
    }
  });

  txTbody.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button[data-act="refund"]');
    if (!btn) return;
    const id = Number(btn.getAttribute('data-id'));
    refundTx = id;

    txRefundError.classList.add('d-none');
    txRefundError.textContent = '';
    txRefundFull.checked = false;
    txRefundAmount.value = '';
    txRefundComment.value = '';

    txRefundTitle.textContent = `Транзакция #${id}`;
    txRefundHint.textContent = 'Можно полный или частичный возврат. Бонусы будут скорректированы автоматически.';

    txRefundModal.show();
  });

  txRefundFull.addEventListener('change', () => {
    txRefundAmount.disabled = txRefundFull.checked;
  });

  txRefundSubmit.addEventListener('click', async () => {
    txRefundSubmit.disabled = true;
    txRefundError.classList.add('d-none');

    try {
      const payload = {
        full_refund: txRefundFull.checked,
        amount: txRefundFull.checked ? null : Number(txRefundAmount.value || 0),
        comment: txRefundComment.value || ''
      };
      await apiPostJson(`/api/transactions/${refundTx}/refund`, payload);
      txRefundModal.hide();
      await loadTransactions(lastPhone);
    } catch (e) {
      txRefundError.textContent = (e && e.message) ? e.message : String(e);
      txRefundError.classList.remove('d-none');
    } finally {
      txRefundSubmit.disabled = false;
    }
  });

  loadTransactions('');
});
</script>
{% endblock %}
