{# This is a Jinja2 template #}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    {% if page_title %}{{ page_title }} ‚Äî LTV Admin{% else %}LTV Admin{% endif %}
  </title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  {% set _v = static_v|default('1') %}
  <link href="/static/css/app.css?v={{ _v }}" rel="stylesheet"/>
</head>

<body class="page-{{ current_page|default('') }}"
      data-user-role="{{ current_user.role if current_user else 'staff' }}"
      data-user-phone="{{ current_user.phone if current_user else '' }}"
      data-user-name="{{ current_user.name if current_user else '' }}">
<div class="app-shell">

  <!-- ‚îÄ‚îÄ Mobile header ‚îÄ‚îÄ -->
  <header class="mobile-header">
    <div class="mobile-brand">
      <div class="brand-badge" style="width:32px;height:32px;font-size:.9rem;">L</div>
      <span class="brand-name" style="font-size:1rem;">LTV</span>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <button class="btn btn-outline-primary btn-sm" type="button"
              data-bs-toggle="offcanvas" data-bs-target="#aiPanel">
        <i class="bi bi-stars"></i>
      </button>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="–ú–µ–Ω—é">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é ‚îÄ‚îÄ -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <aside class="app-sidebar" id="appSidebar">
    <div class="sidebar-brand">
      <div class="brand-badge">L</div>
      <div class="brand-text">
        <div class="brand-name">LTV</div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">–ú–µ–Ω—é</div>

      <a class="nav-item {% if current_page=='desktop' %}active{% endif %}" href="/admin">
        <i class="bi bi-grid-1x2"></i>
        <span>–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</span>
      </a>

      <a class="nav-item {% if current_page=='transactions' %}active{% endif %}" href="/admin/transactions">
        <i class="bi bi-receipt"></i>
        <span>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
      </a>

      {% if current_user and current_user.role in ('owner', 'admin') %}
      <a class="nav-item {% if current_page=='analytics' %}active{% endif %}" href="/admin/analytics">
        <i class="bi bi-bar-chart"></i>
        <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </a>
      {% endif %}

      <a class="nav-item {% if current_page=='clients' or current_page=='clients_db' %}active{% endif %}" href="/admin/clients">
        <i class="bi bi-people"></i>
        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
      </a>

      {% if current_user and current_user.role in ('owner', 'admin') %}
      <a class="nav-item {% if current_page=='campaigns' %}active{% endif %}" href="/admin/campaigns">
        <i class="bi bi-megaphone"></i>
        <span>–†–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</span>
      </a>
      {% endif %}

      {% if current_user and current_user.role in ('owner', 'admin') %}
      <a class="nav-item {% if current_page=='whatsapp' %}active{% endif %}" href="/admin/whatsapp">
        <i class="bi bi-whatsapp"></i>
        <span>WhatsApp</span>
      </a>
      {% endif %}

      <a class="nav-item {% if current_page=='videos' %}active{% endif %}" href="/admin/videos">
        <i class="bi bi-play-circle"></i>
        <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
      </a>

      {% if current_user and current_user.role == 'owner' %}
      <a class="nav-item {% if current_page=='settings' %}active{% endif %}" href="/admin/settings">
        <i class="bi bi-sliders"></i>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
      {% endif %}

      {% if current_user and current_user.role == 'owner' %}
      <a class="nav-item {% if current_page=='accounts' %}active{% endif %}" href="/admin/accounts">
        <i class="bi bi-shield-lock"></i>
        <span>–ê–∫–∫–∞—É–Ω—Ç</span>
      </a>
      {% endif %}
    </div>

    <div class="sidebar-footer">
      {% set u = current_user %}
      {% set uname = (u.name if u and u.name else (u.phone if u and u.phone else "Admin")) %}
      {% set urole = (u.role if u and u.role else "owner") %}
      <div class="sidebar-user">
        <div class="user-avatar">{{ uname[:1]|upper }}</div>
        <div class="user-meta">
          <div class="user-name">{{ uname }}</div>
          <div class="user-role">{{ urole|upper }}</div>
        </div>
      </div>
      <a class="btn btn-sm btn-outline-light w-100 mt-2" href="/logout">
        <i class="bi bi-box-arrow-right me-1"></i> –í—ã–π—Ç–∏
      </a>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
  <main class="app-main">
    <div class="app-topbar">
      <div class="topbar-left">
        <div class="page-title">{{ page_title if page_title else "Dashboard" }}</div>
        <div class="page-subtitle">{{ page_subtitle if page_subtitle else "" }}</div>
      </div>

      <div class="topbar-right d-flex align-items-center gap-2 flex-wrap">
        {% block topbar_actions %}{% endblock %}

        <button class="btn btn-outline-primary btn-sm" type="button" id="aiPanelBtn"
                data-bs-toggle="offcanvas" data-bs-target="#aiPanel"
                title="AI –ø–æ–º–æ—â–Ω–∏–∫">
          <i class="bi bi-stars me-1"></i> AI
        </button>

        <button id="themeToggle" class="btn btn-outline-secondary btn-sm"
                type="button" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <span id="themeIcon">üåô</span>
        </button>
      </div>
    </div>

    <div class="app-content">
      {% block content %}{% endblock %}
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
      <div id="uiToast" class="toast align-items-center text-bg-dark border-0"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="uiToastBody">...</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
                  data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- AI Panel offcanvas -->
    <div class="offcanvas offcanvas-end ai-offcanvas" tabindex="-1"
         id="aiPanel" aria-labelledby="aiPanelLabel">
      <div class="offcanvas-header">
        <div>
          <div class="fw-bold d-flex align-items-center gap-2" id="aiPanelLabel">
            <i class="bi bi-stars" style="color:var(--mint)"></i>
            AI –ø–æ–º–æ—â–Ω–∏–∫
          </div>
          <div class="text-muted small" id="aiPanelContext">–ö–æ–Ω—Ç–µ–∫—Å—Ç: –±–∏–∑–Ω–µ—Å</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>

      <div class="offcanvas-body d-flex flex-column gap-3">

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
        <div class="ai-quick-btns">
          <button class="ai-quick-btn" data-q="–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è –¥–ª—è —Ä–æ—Å—Ç–∞ LTV?">üìà LTV</button>
          <button class="ai-quick-btn" data-q="–ö—Ç–æ –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞ –æ—Ç—Ç–æ–∫–∞?">‚ö†Ô∏è –†–∏—Å–∫</button>
          <button class="ai-quick-btn" data-q="–ö–∞–∫—É—é –∫–∞–º–ø–∞–Ω–∏—é –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å?">üéØ –ö–∞–º–ø–∞–Ω–∏—è</button>
          <button class="ai-quick-btn" data-q="–î–∞–π –æ–±–∑–æ—Ä –±–∏–∑–Ω–µ—Å–∞">üìä –û–±–∑–æ—Ä</button>
        </div>

        <!-- –í–æ–ø—Ä–æ—Å -->
        <div>
          <label class="settings-label mb-1">–í–æ–ø—Ä–æ—Å</label>
          <textarea id="aiPanelQuestion" class="settings-textarea" rows="3"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏?"></textarea>
          <div class="d-flex align-items-center gap-2 mt-2">
            <button class="btn btn-sm btn-success flex-grow-1" type="button" id="aiPanelSendBtn">
              <i class="bi bi-send me-1"></i> –°–ø—Ä–æ—Å–∏—Ç—å
            </button>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="aiPanelClearBtn">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <span id="aiPanelMode" class="badge text-bg-secondary">‚Äî</span>
          </div>
          <div id="aiPanelError" class="text-danger small d-none mt-1"></div>
        </div>

        <!-- –û—Ç–≤–µ—Ç -->
        <div id="aiAnswerBlock" class="d-none">
          <div class="ai-answer-card">
            <div class="ai-answer-label">–û—Ç–≤–µ—Ç</div>
            <div id="aiPanelAnswer" class="ai-answer-text">‚Äî</div>
          </div>

          <div class="mt-3">
            <div class="ai-section-label">–ò–Ω—Å–∞–π—Ç—ã</div>
            <ul id="aiPanelInsights" class="ai-insights-list mb-0"></ul>
          </div>

          <div class="mt-3">
            <div class="ai-section-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
            <div id="aiPanelRecos" class="d-flex flex-column gap-2"></div>
          </div>
        </div>

        <div class="text-muted small mt-auto">
          <i class="bi bi-info-circle me-1"></i>
          –ù–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  function uiToast(message, kind="success") {
    const toastEl = document.getElementById("uiToast");
    const bodyEl  = document.getElementById("uiToastBody");
    if (!toastEl || !bodyEl) { alert(message); return; }
    bodyEl.textContent = message;
    toastEl.classList.remove("text-bg-success","text-bg-danger","text-bg-warning","text-bg-info","text-bg-dark");
    if (kind === "success")     toastEl.classList.add("text-bg-success");
    else if (kind === "error")  toastEl.classList.add("text-bg-danger");
    else if (kind === "warning")toastEl.classList.add("text-bg-warning");
    else if (kind === "info")   toastEl.classList.add("text-bg-info");
    else                        toastEl.classList.add("text-bg-dark");
    if (!window.bootstrap?.Toast) { toastEl.classList.remove("d-none"); return; }
    bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 3000 }).show();
  }
</script>

<script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"
        onerror="var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';document.head.appendChild(s);">
</script>
<script>
  // –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ <body>
  var _b = document.body.dataset;
  window.__USER_ROLE__  = _b.userRole  || "staff";
  window.__USER_PHONE__ = _b.userPhone || "";
  window.__USER_NAME__  = _b.userName  || "";
</script>
<script src="/static/js/admin.js?v={{ _v }}"></script>
{% block scripts %}{% endblock %}
</body>
</html>
